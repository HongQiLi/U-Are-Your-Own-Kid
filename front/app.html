<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>U-AYOK · Quick Test Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:24px; line-height:1.5; }
    h1 { margin:0 0 12px; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:12px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, textarea, button { font: inherit; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; }
    input, textarea { width:100%; max-width:680px; }
    button { cursor:pointer; }
    .ok { color:#059669; }
    .err { color:#dc2626; white-space:pre-wrap; }
    pre { background:#0b1020; color:#d1e7ff; padding:12px; border-radius:8px; overflow:auto; max-height:240px; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#6b7280; }
    .cols { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width: 900px){ .cols{ grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>
  <h1>U-Are-Your-Own-Kid · Quick Test</h1>
  <div class="card">
    <div><small class="mono">Backend:</small> <span id="apiBase"></span></div>
    <div class="row" style="margin-top:8px;">
      <button id="btnHealth">Check /health</button>
      <span id="healthMsg"></span>
    </div>
  </div>

  <div class="cols">
    <!-- 1. Register / Login -->
    <div class="card">
      <h3>1. Register / Login</h3>
      <div class="row"><input id="email" placeholder="Email (e.g., test@example.com)" /></div>
      <div class="row"><input id="password" type="password" placeholder="Password (e.g., Passw0rd!)" /></div>
      <div class="row">
        <select id="role">
          <option value="parent">parent</option>
          <option value="child">child</option>
        </select>
        <input id="nickname" placeholder="Nickname (optional)" style="max-width:240px;" />
      </div>
      <div class="row">
        <button id="btnRegister">Register</button>
        <button id="btnLogin">Login</button>
        <span id="authMsg"></span>
      </div>
      <div><small class="mono">Token:</small> <span id="tokenText" style="word-break:break-all;"></span></div>
    </div>

    <!-- 2. Test OpenAI / Generate Plan -->
    <div class="card">
      <h3>2. Test OpenAI / Generate Plan</h3>
      <div class="row"><input id="goal" placeholder="Goal (e.g., Finish book report in 2 weeks)" /></div>
      <div class="row"><input id="avail" placeholder="Availability (e.g., 09:00-11:00, 14:00-15:00)" /></div>
      <div class="row"><input id="cons" placeholder="Constraints (e.g., Piano class in the afternoon, phone ban)" /></div>
      <div class="row">
        <button id="btnTestLLM">Test OpenAI (/test-llm)</button>
        <button id="btnGeneratePlan">Generate Tasks (/chat/generate)</button>
      </div>
      <div id="llmMsg"></div>
      <pre id="llmOut" style="display:none;"></pre>
    </div>
  </div>

  <!-- 3. Save / Load Events -->
  <div class="card">
    <h3>3. Event Storage (optional)</h3>
    <div class="row">
      <button id="btnSaveEvents">Save generated tasks to calendar (/schedule/events/bulk)</button>
      <button id="btnLoadEvents">Load my events (/schedule/events)</button>
    </div>
    <pre id="eventsOut" style="display:none;"></pre>
  </div>

<script>
const API = window.location.origin;
document.getElementById('apiBase').textContent = API;
let TOKEN = "";

// Helper: message display
const msg = (elId, text, cls="") => {
  const el = document.getElementById(elId);
  el.className = cls;
  el.textContent = text;
};
const showJson = (elId, obj) => {
  const el = document.getElementById(elId);
  el.style.display = "block";
  el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
};

// 1. Health check
document.getElementById('btnHealth').onclick = async () => {
  try {
    const r = await fetch(`${API}/health`);
    msg('healthMsg', r.ok ? 'OK' : `Error ${r.status}`, r.ok ? 'ok' : 'err');
  } catch (e) {
    msg('healthMsg', `Request failed: ${e}`, 'err');
  }
};

// 2. Register
document.getElementById('btnRegister').onclick = async () => {
  const email = document.getElementById('email').value || "test@example.com";
  const password = document.getElementById('password').value || "Passw0rd!";
  const role = document.getElementById('role').value;
  const nickname = document.getElementById('nickname').value;
  try {
    const r = await fetch(`${API}/auth/register`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({email, password, role, nickname})
    });
    const data = await r.json();
    if (!r.ok) throw new Error(JSON.stringify(data));
    msg('authMsg', 'Registered', 'ok');
  } catch (e) {
    msg('authMsg', `Failed: ${e}`, 'err');
  }
};

// 3. Login
document.getElementById('btnLogin').onclick = async () => {
  const email = document.getElementById('email').value || "test@example.com";
  const password = document.getElementById('password').value || "Passw0rd!";
  try {
    const r = await fetch(`${API}/auth/jwt/login`, {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded"},
      body: new URLSearchParams({username: email, password})
    });
    const data = await r.json();
    if (!r.ok) throw new Error(JSON.stringify(data));
    TOKEN = data.access_token;
    document.getElementById('tokenText').textContent = TOKEN;
    msg('authMsg', 'Logged in', 'ok');
  } catch (e) {
    msg('authMsg', `Failed: ${e}`, 'err');
  }
};

// 4. Test OpenAI
document.getElementById('btnTestLLM').onclick = async () => {
  try {
    const q = encodeURIComponent("Say hello from OpenAI");
    const r = await fetch(`${API}/test-llm?prompt=${q}`);
    const data = await r.json();
    showJson('llmOut', data);
    msg('llmMsg', '/test-llm OK', 'ok');
  } catch (e) {
    msg('llmMsg', `Failed: ${e}`, 'err');
  }
};

// 5. Generate Plan
document.getElementById('btnGeneratePlan').onclick = async () => {
  const goal = document.getElementById('goal').value || "Finish book report in 2 weeks";
  const availability = document.getElementById('avail').value || "09:00-11:00, 14:00-15:00";
  const constraints = document.getElementById('cons').value || "Piano class in the afternoon; phone ban";
  if (!TOKEN) { msg('llmMsg','Please login first','err'); return; }
  try {
    const r = await fetch(`${API}/chat/generate`, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization": `Bearer ${TOKEN}`
      },
      body: JSON.stringify({goal, availability, constraints})
    });
    const data = await r.json();
    if (!r.ok) throw new Error(JSON.stringify(data));
    showJson('llmOut', data);
    msg('llmMsg', 'Plan generated', 'ok');
    window.__lastTasks = data.tasks || [];
  } catch (e) {
    msg('llmMsg', `Failed: ${e}`, 'err');
  }
};

// 6. Save Events
document.getElementById('btnSaveEvents').onclick = async () => {
  if (!TOKEN) { msg('llmMsg','Please login first','err'); return; }
  const tasks = window.__lastTasks || [];
  if (!tasks.length) { msg('llmMsg','No tasks to save','err'); return; }
  try {
    const r = await fetch(`${API}/schedule/events/bulk`, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization": `Bearer ${TOKEN}`
      },
      body: JSON.stringify(tasks)
    });
    const data = await r.json();
    if (!r.ok) throw new Error(JSON.stringify(data));
    showJson('eventsOut', data);
    msg('llmMsg', 'Saved to calendar', 'ok');
  } catch (e) {
    msg('llmMsg', `Save failed: ${e}`, 'err');
  }
};

// 7. Load Events
document.getElementById('btnLoadEvents').onclick = async () => {
  if (!TOKEN) { msg('llmMsg','Please login first','err'); return; }
  try {
    const r = await fetch(`${API}/schedule/events`, {
      headers: {"Authorization": `Bearer ${TOKEN}`}
    });
    const data = await r.json();
    if (!r.ok) throw new Error(JSON.stringify(data));
    showJson('eventsOut', data);
  } catch (e) {
    msg('llmMsg', `Load failed: ${e}`, 'err');
  }
};
</script>
</body>
</html>
